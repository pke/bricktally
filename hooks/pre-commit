#!/bin/bash

# Pre-commit hook to auto-increment service worker cache version
# when cached assets are modified

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Files that require cache version bump
CACHED_PATTERNS=(
  "index.html"
  "verify.html"
  "assets/"
  "js/"
)

# Check if any cached files are staged
NEEDS_VERSION_BUMP=false
for file in $STAGED_FILES; do
  for pattern in "${CACHED_PATTERNS[@]}"; do
    if [[ $file == *"$pattern"* ]]; then
      NEEDS_VERSION_BUMP=true
      echo "[pre-commit] Detected change in cached asset: $file"
      break 2
    fi
  done
done

# If cached files changed, update cache version
if [ "$NEEDS_VERSION_BUMP" = true ]; then
  SW_FILE="sw.js"

  if [ ! -f "$SW_FILE" ]; then
    echo "[pre-commit] ERROR: sw.js not found!"
    exit 1
  fi

  # Generate timestamp version
  NEW_VERSION="v$(date +%Y%m%d-%H%M%S)"

  # Update the cache version in sw.js
  sed -i.bak "s/const CACHE_VERSION = 'v[^']*'/const CACHE_VERSION = '$NEW_VERSION'/" "$SW_FILE"

  # Check if sed actually changed the file
  if diff -q "$SW_FILE" "${SW_FILE}.bak" > /dev/null; then
    echo "[pre-commit] ERROR: Failed to update CACHE_VERSION in sw.js"
    rm "${SW_FILE}.bak"
    exit 1
  fi

  # Clean up backup file
  rm "${SW_FILE}.bak"

  # Stage the updated sw.js
  git add "$SW_FILE"

  echo "[pre-commit] âœ“ Updated cache version to: $NEW_VERSION"
else
  echo "[pre-commit] No cached assets changed, skipping version bump"
fi

exit 0
