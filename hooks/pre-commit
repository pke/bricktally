#!/bin/bash

# Pre-commit hook to auto-increment service worker cache version when cached assets are modified
# (Version stamping in index.html is handled by the post-commit hook)
#
# Skip version bump with: SKIP_VERSION_BUMP=1 git commit ...

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# =============================================================================
# Cache version bump for service worker
# =============================================================================

# Allow skipping version bump via env var (useful for chore/test/docs commits)
if [ "$SKIP_VERSION_BUMP" = "1" ]; then
  echo "[pre-commit] Skipping version bump (SKIP_VERSION_BUMP=1)"
  NEEDS_VERSION_BUMP=false
else
  # Files that require cache version bump (only production assets served to users)
  CACHED_PATTERNS=(
    "index.html"
    "verify.html"
    "changelog.html"
    "changelog.json"
    "styles.css"
    "assets/"
    "js/"
  )

  # Check if any cached files are staged
  NEEDS_VERSION_BUMP=false
  for file in $STAGED_FILES; do
    for pattern in "${CACHED_PATTERNS[@]}"; do
      if [[ $file == *"$pattern"* ]]; then
        NEEDS_VERSION_BUMP=true
        echo "[pre-commit] Detected change in cached asset: $file"
        break 2
      fi
    done
  done
fi

# If cached files changed, update cache version
if [ "$NEEDS_VERSION_BUMP" = true ]; then
  SW_FILE="sw.js"

  if [ ! -f "$SW_FILE" ]; then
    echo "[pre-commit] ERROR: sw.js not found!"
    exit 1
  fi

  # Generate timestamp version
  NEW_VERSION="v$(date +%Y%m%d-%H%M%S)"

  # Update the cache version in sw.js
  sed -i.bak "s/const CACHE_VERSION = 'v[^']*'/const CACHE_VERSION = '$NEW_VERSION'/" "$SW_FILE"

  # Check if sed actually changed the file
  if diff -q "$SW_FILE" "${SW_FILE}.bak" > /dev/null; then
    echo "[pre-commit] ERROR: Failed to update CACHE_VERSION in sw.js"
    rm "${SW_FILE}.bak"
    exit 1
  fi

  # Clean up backup file
  rm "${SW_FILE}.bak"

  # Stage the updated sw.js
  git add "$SW_FILE"

  echo "[pre-commit] ✓ Updated cache version to: $NEW_VERSION"
else
  echo "[pre-commit] No cached assets changed, skipping version bump"
fi

# =============================================================================
# Changelog reminder for user-facing changes
# =============================================================================

# Files that represent user-facing changes (features, UI, behavior)
USER_FACING_PATTERNS=(
  "index.html"
  "verify.html"
  "styles.css"
  "js/"
)

HAS_USER_FACING=false
for file in $STAGED_FILES; do
  for pattern in "${USER_FACING_PATTERNS[@]}"; do
    if [[ $file == *"$pattern"* ]]; then
      HAS_USER_FACING=true
      break 2
    fi
  done
done

HAS_CHANGELOG=false
for file in $STAGED_FILES; do
  if [[ $file == "changelog.json" ]]; then
    HAS_CHANGELOG=true
    break
  fi
done

if [ "$HAS_USER_FACING" = true ] && [ "$HAS_CHANGELOG" = false ]; then
  echo ""
  echo "[pre-commit] ⚠️  User-facing files changed but changelog.json was not updated."
  echo "[pre-commit]    If this is a user-visible change, consider updating changelog.json."
  echo ""
fi

exit 0
