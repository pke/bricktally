#!/bin/bash

# Pre-commit hook to:
# 1. Auto-increment service worker cache version when cached assets are modified
# 2. Inject git hash into HTML version footer

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# =============================================================================
# Part 1: Update version info in HTML files
# =============================================================================

# Get version from package.json
VERSION=$(grep '"version"' package.json | sed 's/.*"version": *"\([^"]*\)".*/\1/')

# Get the short git hash (will be the NEW commit hash after this commit)
# Use HEAD for now, it will be accurate after the commit
GIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "dev")

# Update version in index.html
if [ -f "index.html" ]; then
  # Update the version span content
  sed -i.bak "s|<span id=\"versionInfo\">v[^<]*</span>|<span id=\"versionInfo\">v${VERSION} (${GIT_HASH})</span>|" "index.html"

  if ! diff -q "index.html" "index.html.bak" > /dev/null 2>&1; then
    rm "index.html.bak"
    git add "index.html"
    echo "[pre-commit] ✓ Updated version to: v${VERSION} (${GIT_HASH})"
  else
    rm "index.html.bak"
  fi
fi

# =============================================================================
# Part 2: Cache version bump for service worker
# =============================================================================

# Files that require cache version bump
CACHED_PATTERNS=(
  "index.html"
  "verify.html"
  "styles.css"
  "assets/"
  "js/"
)

# Check if any cached files are staged
NEEDS_VERSION_BUMP=false
for file in $STAGED_FILES; do
  for pattern in "${CACHED_PATTERNS[@]}"; do
    if [[ $file == *"$pattern"* ]]; then
      NEEDS_VERSION_BUMP=true
      echo "[pre-commit] Detected change in cached asset: $file"
      break 2
    fi
  done
done

# If cached files changed, update cache version
if [ "$NEEDS_VERSION_BUMP" = true ]; then
  SW_FILE="sw.js"

  if [ ! -f "$SW_FILE" ]; then
    echo "[pre-commit] ERROR: sw.js not found!"
    exit 1
  fi

  # Generate timestamp version
  NEW_VERSION="v$(date +%Y%m%d-%H%M%S)"

  # Update the cache version in sw.js
  sed -i.bak "s/const CACHE_VERSION = 'v[^']*'/const CACHE_VERSION = '$NEW_VERSION'/" "$SW_FILE"

  # Check if sed actually changed the file
  if diff -q "$SW_FILE" "${SW_FILE}.bak" > /dev/null; then
    echo "[pre-commit] ERROR: Failed to update CACHE_VERSION in sw.js"
    rm "${SW_FILE}.bak"
    exit 1
  fi

  # Clean up backup file
  rm "${SW_FILE}.bak"

  # Stage the updated sw.js
  git add "$SW_FILE"

  echo "[pre-commit] ✓ Updated cache version to: $NEW_VERSION"
else
  echo "[pre-commit] No cached assets changed, skipping version bump"
fi

exit 0
