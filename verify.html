<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set Verification - BrickTally</title>
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Mobile Web App Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BrickTally">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #f5f5f5;
      --bg-secondary: white;
      --bg-tertiary: #f9f9f9;
      --text-primary: #333;
      --text-secondary: #666;
      --border-color: #ddd;
      --shadow: rgba(0, 0, 0, 0.1);
      --blue: #0055BF;
      --green: #4CAF50;
      --orange: #FF9800;
      --red: #FF6B6B;
    }

    body.dark-mode {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3a3a3a;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #444;
      --shadow: rgba(0, 0, 0, 0.5);
      --blue: #4a9eff;
      --green: #66bb6a;
      --orange: #ffb74d;
      --red: #ff6b6b;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
      position: relative;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-secondary);
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow);
      position: relative;
    }

    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 8px;
      line-height: 1;
      transition: transform 0.3s ease;
      z-index: 10;
    }

    .theme-toggle:hover {
      transform: scale(1.2);
    }

    h1 {
      color: var(--blue);
      margin-bottom: 10px;
      font-size: 24px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding-right: 50px;
    }

    .set-header {
      margin: 20px 0;
      text-align: center;
    }

    .set-image {
      max-width: 400px;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 14px;
    }

    .status-complete {
      background: var(--green);
      color: white;
    }

    .status-incomplete {
      background: var(--orange);
      color: white;
    }

    .stats {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: var(--blue);
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .progress-bar {
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      height: 40px;
      margin: 20px 0;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: var(--green);
      transition: width 0.3s ease;
    }

    .progress-fill.incomplete {
      background: var(--orange);
    }

    .progress-bar::after {
      content: attr(data-percentage);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 18px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .export-btn {
      display: inline-block;
      margin: 10px 10px 10px 0;
      padding: 12px 24px;
      background: var(--orange);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    .export-btn:hover {
      background: #F57C00;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .col-info {
      line-height: 1.5;
    }

    .missing-col {
      text-align: right;
    }

    th {
      background: var(--blue);
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background: var(--bg-tertiary);
    }

    .part-image {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .missing-count {
      background: var(--red);
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
    }

    .no-missing {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .no-missing .checkmark {
      font-size: 64px;
      color: var(--green);
      margin-bottom: 20px;
    }

    .back-link {
      display: inline-block;
      margin-top: 30px;
      padding: 12px 24px;
      background: var(--blue);
      color: white;
      text-decoration: none;
      border-radius: 6px;
    }

    .back-link:hover {
      background: #003d8f;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .theme-toggle {
        top: 15px;
        right: 15px;
        font-size: 20px;
      }

      .title-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding-right: 40px;
      }

      h1 {
        font-size: 20px;
      }

      .set-image {
        max-width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      th,
      td {
        padding: 8px;
        font-size: 14px;
      }

      .part-image {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <button class="theme-toggle" id="themeToggle" onclick="toggleDarkMode()">
      <span id="themeIcon">üåô</span>
    </button>

    <div id="content">
      <p>Loading verification data...</p>
    </div>

    <a href="/" class="back-link">‚Üê Back to BrickTally</a>
  </div>

  <script>
    var API_KEY = '6052dd0b655bdfede6e58d5166e96e76';
    var currentMissingParts = [];

    // Load dark mode preference from localStorage
    function loadDarkMode() {
      var darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.body.classList.add('dark-mode');
        updateThemeIcon();
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      var isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      updateThemeIcon();
    }

    function updateThemeIcon() {
      var isDark = document.body.classList.contains('dark-mode');
      var themeIcon = document.getElementById('themeIcon');
      // When dark mode is active, show sun (to switch to light)
      // When light mode is active, show moon (to switch to dark)
      themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    // Initialize dark mode on page load
    loadDarkMode();

    function getPartKey(part) {
      var color = part.color || 'Unknown';
      var key = part.partNum + '_' + color;
      if (part.isSpare) {
        key += '_s';
      }
      return key;
    }

    function parseUrlParams() {
      var params = new URLSearchParams(window.location.search);
      return {
        setNumber: params.get('set'),
        missingData: params.get('missing') || ''
      };
    }

    function parseMissingData(missingData) {
      var missing = {};
      if (!missingData) return missing;

      missingData.split(',').forEach(function (part) {
        if (!part) return;
        var split = part.split(':');
        missing[split[0]] = parseInt(split[1]);
      });

      return missing;
    }

    function loadSetData(setNumber) {
      return fetch('https://rebrickable.com/api/v3/lego/sets/' + setNumber + '/', {
        headers: {
          'Accept': 'application/json',
          'Authorization': 'key ' + API_KEY
        }
      })
        .then(function (response) {
          if (!response.ok) throw new Error('Set not found');
          return response.json();
        });
    }

    function loadAllParts(setNumber) {
      var allParts = [];

      function fetchPage(page) {
        return fetch('https://rebrickable.com/api/v3/lego/sets/' + setNumber + '/parts/?page_size=1000&page=' + page, {
          headers: {
            'Accept': 'application/json',
            'Authorization': 'key ' + API_KEY
          }
        })
          .then(function (response) {
            if (!response.ok) throw new Error('Error fetching parts');
            return response.json();
          })
          .then(function (data) {
            if (data.results && data.results.length > 0) {
              allParts = allParts.concat(data.results);
            }

            if (data.next) {
              return fetchPage(page + 1);
            } else {
              return allParts;
            }
          });
      }

      return fetchPage(1);
    }

    function exportToBrickLink() {
      if (currentMissingParts.length === 0) {
        alert('No missing pieces to export!');
        return;
      }

      var xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
      xml += '<INVENTORY>\n';

      currentMissingParts.forEach(function (item) {
        xml += '  <ITEM>\n';
        xml += '    <ITEMTYPE>P</ITEMTYPE>\n';
        xml += '    <ITEMID>' + item.part.partNum + '</ITEMID>\n';
        xml += '    <COLORNAME>' + item.part.color + '</COLORNAME>\n';
        xml += '    <MINQTY>' + item.missing + '</MINQTY>\n';
        xml += '  </ITEM>\n';
      });

      xml += '</INVENTORY>';

      var blob = new Blob([xml], { type: 'text/xml' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'bricklink-wanted-list-' + parseUrlParams().setNumber.replace('-', '_') + '.xml';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      alert('BrickLink XML file downloaded!\n\nTo use:\n1. Go to BrickLink.com\n2. Navigate to "Want" > "Upload"\n3. Select "BrickLink XML" format\n4. Upload the downloaded file');
    }

    function exportToPickABrick() {
      if (currentMissingParts.length === 0) {
        alert('No missing pieces to export!');
        return;
      }

      var csv = 'Element ID,Design ID,Colour,Quantity,Name\n';

      currentMissingParts.forEach(function (item) {
        csv += ',' + item.part.partNum + ',' + item.part.color + ',' + item.missing + ',"' + item.part.name + '"\n';
      });

      var blob = new Blob([csv], { type: 'text/csv' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'pick-a-brick-list-' + parseUrlParams().setNumber.replace('-', '_') + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      alert('Pick a Brick CSV file downloaded!\n\nNote: This is a reference list. You\'ll need to manually search and add items on LEGO.com/pick-a-brick as they don\'t support bulk import.');
    }

    function exportMissingPartsText() {
      if (currentMissingParts.length === 0) {
        alert('No missing pieces to export!');
        return;
      }

      var setNumber = parseUrlParams().setNumber.split('-')[0];
      var text = 'Missing Pieces for Set ' + setNumber + '\n';
      text += '='.repeat(50) + '\n\n';

      currentMissingParts.forEach(function (item) {
        text += item.missing + 'x ' + item.part.partNum + ' - ' + item.part.name + ' (' + item.part.color + ')\n';
      });

      text += '\n' + '='.repeat(50) + '\n';
      text += 'Total unique parts missing: ' + currentMissingParts.length + '\n';

      var totalPieces = 0;
      currentMissingParts.forEach(function (item) { totalPieces += item.missing; });
      text += 'Total pieces missing: ' + totalPieces + '\n';

      var blob = new Blob([text], { type: 'text/plain' });
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'missing-parts-' + parseUrlParams().setNumber.replace('-', '_') + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function displayVerification(setData, partsData, missingParts) {
      var totalPieces = 0;
      var missingPiecesCount = 0;
      var missingPartsList = [];

      partsData.forEach(function (item, index) {
        var part = {
          id: index,
          partNum: item.part.part_num || 'unknown',
          name: item.part.name || 'Unknown Part',
          color: (item.color && item.color.name) ? item.color.name : 'Unknown',
          quantity: item.quantity || 0,
          imageUrl: item.part.part_img_url || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="60" height="60"%3E%3Crect width="60" height="60" fill="%23ddd"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="10" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E',
          isSpare: item.is_spare || false
        };

        if (part.isSpare) return;

        totalPieces += part.quantity;
        var key = getPartKey(part);

        if (missingParts[key]) {
          missingPiecesCount += missingParts[key];
          missingPartsList.push({
            part: part,
            missing: missingParts[key]
          });
        }
      });

      currentMissingParts = missingPartsList;

      var completedPieces = totalPieces - missingPiecesCount;
      var percentage = totalPieces > 0 ? Math.round((completedPieces / totalPieces) * 100) : 0;
      var isComplete = percentage === 100;

      var setImageUrl = setData.set_img_url || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect width="400" height="300" fill="%23ddd"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="20" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E';

      // Format set number for display
      var params = parseUrlParams();
      var versionParts = params.setNumber.split('-');
      var versionNumber = versionParts[1];
      var displaySetNumber = versionParts[0];
      var versionInfo = versionNumber !== '1' ?
        ' <span style="color: var(--orange);">(Version ' + versionNumber + ')</span>' : '';

      var html = '<div class="title-row">' +
        '<h1>üß± BrickTally - Set Verification</h1>' +
        '<div class="status-badge ' + (isComplete ? 'status-complete' : 'status-incomplete') + '">' +
        (isComplete ? '‚úì COMPLETE' : '‚ö† INCOMPLETE') +
        '</div>' +
        '</div>' +
        '<h2>' + setData.name + '</h2>' +
        '<p style="color: var(--text-secondary); margin: 10px 0 20px 0;">Set Number: ' + displaySetNumber + versionInfo + ' | Year: ' + setData.year + '</p>' +
        '<div class="set-header">' +
        '<img src="' + setImageUrl + '" alt="' + setData.name + '" class="set-image">' +
        '</div>' +
        '<div class="stats">' +
        '<h3>Completeness Overview</h3>' +
        '<div class="stats-grid">' +
        '<div class="stat-item"><div class="stat-value">' + percentage + '%</div><div class="stat-label">Complete</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + completedPieces + '</div><div class="stat-label">Pieces Found</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + missingPiecesCount + '</div><div class="stat-label">Pieces Missing</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + totalPieces + '</div><div class="stat-label">Total Pieces</div></div>' +
        '</div>' +
        '<div class="progress-bar" data-percentage="' + percentage + '%">' +
        '<div class="progress-fill ' + (isComplete ? '' : 'incomplete') + '" style="width: ' + percentage + '%;"></div>' +
        '</div>' +
        '</div>';

      if (missingPartsList.length === 0) {
        html += '<div class="no-missing">' +
          '<div class="checkmark">‚úì</div>' +
          '<h2>All Pieces Accounted For!</h2>' +
          '<p>This set is 100% complete.</p>' +
          '</div>';
      } else {
        html += '<div style="margin-top: 30px;">' +
          '<!-- Replace the single export button with multiple options --><div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap;">    <button class="export-btn" onclick="exportToBrickLink()">üì¶ BrickLink XML</button>    <button class="export-btn" onclick="exportToPickABrick()">üß± Pick a Brick CSV</button>    <button class="export-btn" onclick="exportMissingPartsText()">üìÑ Text List</button></div>' +
          '</div>' +
          '<h3 style="margin-top: 30px;">Missing Pieces (' + missingPartsList.length + ' unique parts)</h3>' +
          '<table>' +
          '<thead><tr>' +
          '<th style="width: 80px;">Image</th>' +
          '<th>Part</th>' +
          '<th class="missing-col" style="width: 120px;">Missing</th>' +
          '</tr></thead><tbody>';

        missingPartsList.forEach(function (item) {
          var partInfo = item.part.color + ' ' + item.part.name + '<br>' + item.part.partNum;

          html += '<tr>' +
            '<td><img src="' + item.part.imageUrl + '" alt="' + item.part.name + '" class="part-image"></td>' +
            '<td class="col-info">' + partInfo + '</td>' +
            '<td class="missing-col"><span class="missing-count">' + item.missing + '</span></td>' +
            '</tr>';
        });

        html += '</tbody></table>';
      }

      document.getElementById('content').innerHTML = html;
    }

    // Initialize
    var params = parseUrlParams();

    if (!params.setNumber) {
      document.getElementById('content').innerHTML = '<div class="no-missing"><h2>Invalid Verification Link</h2><p>No set specified.</p></div>';
    } else {
      var missingParts = parseMissingData(params.missingData);

      loadSetData(params.setNumber)
        .then(function (setData) {
          return loadAllParts(params.setNumber).then(function (partsData) {
            return { setData: setData, partsData: partsData };
          });
        })
        .then(function (result) {
          displayVerification(result.setData, result.partsData, missingParts);
        })
        .catch(function (error) {
          document.getElementById('content').innerHTML = '<div class="no-missing"><h2>Error Loading Set</h2><p>' + error.message + '</p></div>';
        });
    }
  </script>
</body>

</html>